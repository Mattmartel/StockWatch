<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Â· Today</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap');

    :root {
      --bg:         #080810;
      --surface:    #13131c;
      --surface2:   #1c1c28;
      --border:     #2e2e42;
      --border-hi:  #48486a;
      --text:       #f0f0f8;
      --secondary:  #c8c8e0;   /* was near-invisible grey â€” now proper readable */
      --dim:        #9898b8;   /* lowest tier â€” still passes contrast on dark bg */
      --green:      #1aff8c;
      --green-dim:  rgba(26,255,140,0.14);
      --red:        #ff5577;
      --red-dim:    rgba(255,85,119,0.14);
      --accent:     #7c6af7;
      --yellow:     #ffd060;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { font-size: 17px; }   /* bump base â€” everything rem-based scales up */

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      padding: 1.4rem 1.1rem 4rem;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .logo { display: flex; align-items: center; gap: 0.6rem; }

    .logo-icon {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, #1aff8c, #00c8ff);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 17px;
    }

    .logo-text {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      font-weight: 600;
      color: var(--secondary);
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .setup-btn {
      background: var(--surface2);
      color: var(--secondary);
      border: 1px solid var(--border-hi);
      padding: 0.55rem 1.1rem;
      border-radius: 8px;
      font-size: 0.89rem;
      font-family: 'DM Mono', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 44px;   /* iOS touch target */
    }
    .setup-btn:hover { color: var(--text); border-color: #888; }

    /* â”€â”€ Summary Cards â”€â”€ */
    .summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .summary-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.25rem 1.35rem;
    }

    .summary-card.full { grid-column: span 2; }

    .summary-label {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--dim);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .summary-value {
      font-size: 1.95rem;
      font-weight: 700;
      letter-spacing: -0.04em;
      line-height: 1;
      color: var(--text);
    }

    .summary-value.total-value {
      font-size: 2.6rem;
      color: #ffffff;
    }

    .summary-sub {
      font-size: 0.95rem;
      color: var(--secondary);
      margin-top: 0.4rem;
      font-weight: 500;
    }

    .green { color: var(--green); }
    .red   { color: var(--red); }

    /* â”€â”€ Chart Section â”€â”€ */
    .chart-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.1rem 1.1rem 0.9rem;
      margin-bottom: 1.25rem;
    }

    .section-title {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--dim);
      margin-bottom: 0.9rem;
      font-weight: 600;
    }

    .chart-wrap { position: relative; height: 230px; }

    @media (max-width: 480px) {
      .chart-wrap { height: auto; min-height: 200px; }
      .chart-section { max-width: 430px; margin-left: auto; margin-right: auto; overflow: hidden; }
    }

    /* â”€â”€ Holdings List â”€â”€ */
    .holdings-list { display: flex; flex-direction: column; gap: 0.65rem; }

    .holding-row {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.05rem 1.15rem;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: start;
      gap: 0.75rem;
    }

    .holding-row.up   { border-left: 4px solid var(--green); }
    .holding-row.down { border-left: 4px solid var(--red); }

    .holding-name {
      font-weight: 700;
      font-size: 1.1rem;
      line-height: 1.25;
      color: #ffffff;
    }

    .holding-ticker {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      color: var(--secondary);
      margin-top: 0.2rem;
      font-weight: 500;
    }

    .holding-meta {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.35rem;
      flex-wrap: wrap;
    }

    /* Peak: plain text, barely there unless severe */
    .peak-badge {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      color: #4a4a6a;
      font-weight: 500;
    }
    .peak-badge.warn  { color: var(--yellow); opacity: 0.6; }
    .peak-badge.alert { color: var(--red);    opacity: 0.55; }

    .holding-right { text-align: right; flex-shrink: 0; }

    /* Day $ change â€” the headline number */
    .holding-change {
      font-family: 'DM Mono', monospace;
      font-size: 1.15rem;
      font-weight: 700;
      white-space: nowrap;
    }

    /* Current price â€” secondary but readable */
    .holding-price {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      font-weight: 500;
      color: var(--secondary);
      margin-top: 0.25rem;
      text-align: right;
    }

    /* Total holding value + P/L */
    .holding-value {
      font-family: 'DM Mono', monospace;
      font-size: 0.92rem;
      font-weight: 700;
      color: #ffffff;
      margin-top: 0.3rem;
      white-space: nowrap;
    }

    .pct-badge {
      display: inline-block;
      font-size: 0.89rem;
      font-family: 'DM Mono', monospace;
      padding: 0.18rem 0.45rem;
      border-radius: 5px;
      margin-left: 0.35rem;
      font-weight: 700;
    }

    .pct-badge.up   { background: var(--green-dim); color: var(--green); }
    .pct-badge.down { background: var(--red-dim);   color: var(--red); }

    /* â”€â”€ Empty/Setup State â”€â”€ */
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--secondary); }
    .empty-state p { font-size: 1rem; margin-bottom: 1rem; }

    .empty-setup-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.75rem 1.75rem;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      min-height: 44px;
    }

    /* â”€â”€ Modal â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.88);
      z-index: 100;
      align-items: center; justify-content: center;
      padding: 1.5rem;
    }
    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border-hi);
      border-radius: 18px;
      padding: 1.75rem;
      width: 100%; max-width: 420px;
      max-height: 90vh; overflow-y: auto;
    }

    .modal h2 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 1.35rem;
      color: #ffffff;
    }

    .field { margin-bottom: 1rem; }

    .field label {
      display: block;
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--secondary);
      margin-bottom: 0.45rem;
      font-weight: 600;
    }

    .field input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border-hi);
      color: var(--text);
      padding: 0.7rem 0.9rem;
      border-radius: 9px;
      font-size: 1rem;
      font-family: 'DM Sans', sans-serif;
      outline: none;
      transition: border-color 0.2s;
      min-height: 48px;
    }
    .field input:focus { border-color: var(--accent); }

    .modal-actions { display: flex; gap: 0.65rem; margin-top: 1.5rem; }

    .btn-save {
      flex: 1;
      background: var(--accent);
      color: white; border: none;
      padding: 0.75rem;
      border-radius: 9px;
      font-size: 1rem; font-weight: 600;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      min-height: 48px;
    }

    .btn-cancel {
      flex: 1;
      background: var(--surface2);
      color: var(--secondary);
      border: 1px solid var(--border-hi);
      padding: 0.75rem;
      border-radius: 9px;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      min-height: 48px;
    }

    /* â”€â”€ Timestamp â”€â”€ */
    .timestamp {
      font-family: 'DM Mono', monospace;
      font-size: 0.89rem;
      color: var(--secondary);
      text-align: center;
      margin-top: 2rem;
      font-weight: 500;
    }

    /* â”€â”€ Loading â”€â”€ */
    @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
    .loading { animation: pulse 1.5s ease-in-out infinite; }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo">
      <div class="logo-icon">ðŸ“ˆ</div>
      <span class="logo-text">Portfolio Â· Today</span>
    </div>
    <button class="setup-btn" id="setupBtn">Setup</button>
  </div>

  <div id="app">
    <div class="empty-state">
      <p>Connect your Google Sheets to get started</p>
      <button class="empty-setup-btn" id="emptySetupBtn">Connect Sheet</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h2>Google Sheets Setup</h2>
      <div class="field">
        <label>Sheets URL</label>
        <input id="sheetsUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." />
      </div>
      <div class="field">
        <label>API Key</label>
        <input id="apiKey" type="text" placeholder="AIzaSy..." />
      </div>
      <div class="field">
        <label>Sheet Name</label>
        <input id="sheetName" type="text" value="Sheet1" />
      </div>
      <div class="modal-actions">
        <button class="btn-save" id="saveBtn">Save & Load</button>
        <button class="btn-cancel" id="cancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let SHEET_ID = localStorage.getItem('sr_sheetId') || '';
    let API_KEY  = localStorage.getItem('sr_apiKey')  || '';
    let SHEET_NAME = localStorage.getItem('sr_sheetName') || 'Sheet1';
    let portfolioData = [];
    let barChart = null;

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cleanPrice(p) {
      if (!p) return 0;
      const s = String(p).trim();
      if (s === '#N/A' || s === '#NA' || s === 'N/A' || s === '') return 0;
      const n = parseFloat(s.replace(/[$,]/g, ''));
      return isNaN(n) ? 0 : n;
    }

    function fmt(n, dp = 0) {
      const abs = Math.abs(n);
      const str = abs.toLocaleString('en-NZ', { minimumFractionDigits: dp, maximumFractionDigits: dp });
      return (n < 0 ? '-$' : '$') + str;
    }

    function fmtPct(n) {
      return (n >= 0 ? '+' : '') + n.toFixed(1) + '%';
    }

    function getStockValue(s) {
      const tv = cleanPrice(s['Total current value']);
      if (tv > 0) return tv;
      return (parseFloat(s.Quantity) || 0) * cleanPrice(s['Current Price']);
    }

    function getStockCost(s) {
      const tc = cleanPrice(s['Total purchase price']);
      if (tc > 0) return tc;
      return (parseFloat(s.Quantity) || 0) * cleanPrice(s['Purchase Price']);
    }

    function isWatchlisted(s) {
      const w = (s.Watchlist || '').toString().toLowerCase();
      return w === 'yes' || w === 'true' || w === '1' || w === 'x';
    }

    function getDayChange(s) {
      const curr = cleanPrice(s['Current Price']);
      const prev = cleanPrice(s['Day-1']);
      const qty  = parseFloat(s.Quantity) || 0;
      if (!prev || !curr) return { dollar: 0, pct: 0 };
      return {
        dollar: (curr - prev) * qty,
        pct:    ((curr - prev) / prev) * 100
      };
    }

    // From peak: uses 52w High (col M, index 12) and 52w Low (col N, index 13) from sheet
    // Stored as _52wHigh / _52wLow when loading data
    function getFromPeak(s) {
      const curr    = cleanPrice(s['Current Price']);
      const high52  = cleanPrice(s['_52wHigh']);
      const low52   = cleanPrice(s['_52wLow']);
      if (!curr || !high52) return null;
      const fromHigh = ((curr - high52) / high52) * 100;
      const range    = high52 - low52;
      const posInRange = range > 0 ? ((curr - low52) / range) * 100 : null;
      const atPeak   = curr >= high52 * 0.999; // within 0.1% counts as at peak
      return { pct: fromHigh, atPeak, posInRange, high52, low52 };
    }

    function isMobile() {
      return window.innerWidth <= 600;
    }

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      if (!portfolioData.length) return;

      const stocks = portfolioData.filter(s => !isWatchlisted(s));

      const totalValue  = stocks.reduce((sum, s) => sum + getStockValue(s), 0);
      const totalCost   = stocks.reduce((sum, s) => sum + getStockCost(s), 0);
      const totalPL     = totalValue - totalCost;
      const totalPLPct  = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;
      const totalDayChg = stocks.reduce((sum, s) => sum + getDayChange(s).dollar, 0);
      const totalDayPct = totalValue > 0 ? (totalDayChg / (totalValue - totalDayChg)) * 100 : 0;
      const isUp = totalDayChg >= 0;
      const isPLUp = totalPL >= 0;

      let html = '';

      // â”€â”€ Summary cards â”€â”€
      html += `<div class="summary">
        <div class="summary-card full">
          <div class="summary-label">Total Portfolio Value</div>
          <div class="summary-value total-value">${fmt(totalValue, 0)}</div>
          <div style="margin-top:0.5rem; font-family:'DM Mono',monospace; font-size:0.95rem; font-weight:700; color:${isPLUp ? 'var(--green)' : 'var(--red)'}; white-space:nowrap;">
            ${isPLUp ? '+' : ''}${fmt(totalPL, 0)}&nbsp;<span style="font-size:0.9rem; color:${isPLUp ? '#1aff8c' : '#ff5577'};">(${fmtPct(totalPLPct)})</span>
            <span style="font-size:0.89rem; font-weight:500; color:var(--secondary); margin-left:0.5rem;">total return</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Today's Change</div>
          <div class="summary-value ${isUp ? 'green' : 'red'}">${fmt(totalDayChg, 0)}</div>
          <div class="summary-sub">${fmtPct(totalDayPct)} vs yesterday</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Movers</div>
          <div class="summary-value" style="font-size:1.4rem;">
            <span class="green">${stocks.filter(s => getDayChange(s).dollar > 0).length} â†‘</span>
            &nbsp;
            <span class="red">${stocks.filter(s => getDayChange(s).dollar < 0).length} â†“</span>
          </div>
          <div style="margin-top:0.45rem; display:flex; flex-direction:column; gap:0.2rem;">
            <div style="font-family:'DM Mono',monospace; font-size:0.89rem; font-weight:600; color:var(--green);">
              +${fmt(stocks.reduce((sum, s) => { const c = getDayChange(s).dollar; return sum + (c > 0 ? c : 0); }, 0), 0)}
            </div>
            <div style="font-family:'DM Mono',monospace; font-size:0.89rem; font-weight:600; color:var(--red);">
              ${fmt(stocks.reduce((sum, s) => { const c = getDayChange(s).dollar; return sum + (c < 0 ? c : 0); }, 0), 0)}
            </div>
          </div>
        </div>
      </div>`;

      // â”€â”€ Bar chart â”€â”€
      // Sort: increases first (largest first), then decreases (least negative first)
      const sorted = [...stocks].sort((a, b) => {
        const ga = getDayChange(a).dollar;
        const gb = getDayChange(b).dollar;
        const aPos = ga >= 0, bPos = gb >= 0;
        if (aPos && !bPos) return -1;
        if (!aPos && bPos) return 1;
        return gb - ga;
      });
      const mobile = isMobile();
      // On mobile: horizontal bars, height scales with number of stocks
      const chartHeight = mobile ? Math.max(200, sorted.length * 40) : 220;
      html += `<div class="chart-section">
        <div class="section-title">Today's Change Per Holding</div>
        <div class="chart-wrap" style="height:${chartHeight}px"><canvas id="barChart"></canvas></div>
      </div>`;

      // â”€â”€ Holdings list â”€â”€
      html += '<div class="holdings-list">';
      sorted.forEach(s => {
        const chg  = getDayChange(s);
        const val  = getStockValue(s);
        const peak = getFromPeak(s);
        const dir  = chg.dollar >= 0 ? 'up' : 'down';
        const cls  = chg.dollar >= 0 ? 'green' : 'red';
        const name   = s['Firm name'] || s['Ticker/Symbol'] || 'Unknown';
        const ticker = s['Ticker/Symbol'] || '';

        // Peak badge
        let peakHtml = '';
        if (peak) {
          if (peak.atPeak) {
            peakHtml = `<span class="peak-badge">At peak</span>`;
          } else {
            const badgeCls = peak.pct < -20 ? 'alert' : peak.pct < -10 ? 'warn' : '';
            peakHtml = `<span class="peak-badge ${badgeCls}">Peak ${peak.pct.toFixed(1)}%</span>`;
          }
        }

        const cost    = getStockCost(s);
        const pl      = val - cost;
        const plCls   = pl >= 0 ? 'var(--green)' : 'var(--red)';
        const plStr   = (pl >= 0 ? '+' : '') + fmt(pl, 0);

        html += `<div class="holding-row ${dir}">
          <div>
            <div class="holding-name">${name}</div>
            <div class="holding-ticker">${ticker}</div>
            <div class="holding-meta">${peakHtml}</div>
          </div>
          <div class="holding-right">
            <div class="holding-change ${cls}">
              ${fmt(chg.dollar, 0)}
              <span class="pct-badge ${dir}">${fmtPct(chg.pct)}</span>
            </div>
            <div class="holding-price">
              $${cleanPrice(s['Current Price']).toFixed(2)}
            </div>
            <div class="holding-value">
              ${fmt(val, 0)}&nbsp;<span style="color:${plCls}; font-weight:700;">${plStr}</span>
            </div>
          </div>
        </div>`;
      });
      html += '</div>';

      html += `<div class="timestamp">Updated ${new Date().toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' })}</div>`;

      document.getElementById('app').innerHTML = html;
      buildChart(sorted, mobile);
    }

    function buildChart(stocks, mobile) {
      const canvas = document.getElementById('barChart');
      if (!canvas) return;

      if (barChart) barChart.destroy();
      Chart.defaults.color = '#9898b8';
      Chart.defaults.borderColor = '#2e2e42';

      const isHoriz = !!mobile;

      // Gains first, biggest gain at index 0.
      // Chart.js: index 0 = TOP for horizontal, LEFT for vertical â€” gains first works for both.
      const sortedForDisplay = [...stocks].sort((a, b) => {
        const ga = getDayChange(a).dollar;
        const gb = getDayChange(b).dollar;
        if (ga >= 0 && gb < 0) return -1;
        if (ga < 0 && gb >= 0) return 1;
        return gb - ga;
      });

      const dispTickers  = sortedForDisplay.map(s => s['Ticker/Symbol'] || s['Firm name'] || '?');
      const dispNames    = sortedForDisplay.map(s => (s['Firm name'] || s['Ticker/Symbol'] || '?').split(' ').slice(0, 2).join(' '));
      const dispValues   = sortedForDisplay.map(s => getDayChange(s).dollar);
      const dispColors   = dispValues.map(v => v >= 0 ? 'rgba(0,230,118,0.85)' : 'rgba(255,77,109,0.85)');
      const dispBorders  = dispValues.map(v => v >= 0 ? '#00e676' : '#ff4d6d');
      const dispStocks   = sortedForDisplay;

      // Custom plugin: draw company name inside/outside bar end
      const nameLabelPlugin = {
        id: 'nameLabels',
        afterDatasetsDraw(chart) {
          if (!isHoriz) return;
          const { ctx, data } = chart;
          const meta = chart.getDatasetMeta(0);
          ctx.save();
          ctx.font = '600 15px "DM Mono", monospace';
          meta.data.forEach((bar, i) => {
            const val   = data.datasets[0].data[i];
            const name  = dispNames[i];
            const isPos = val >= 0;
            const padding = 6;
            if (isPos) {
              ctx.textAlign = 'left';
              ctx.fillStyle = 'rgba(0,230,118,0.65)';
              ctx.fillText(name, bar.x + padding, bar.y + 4);
            } else {
              ctx.textAlign = 'right';
              ctx.fillStyle = 'rgba(255,77,109,0.65)';
              ctx.fillText(name, bar.x - padding, bar.y + 4);
            }
          });
          ctx.restore();
        }
      };

      const axisTickConfig = {
        font: { family: 'DM Mono', size: 15, weight: '700' },
        color: '#ffffff',
        callback: v => (v >= 0 ? '$' : '-$') + Math.abs(v).toLocaleString()
      };

      barChart = new Chart(canvas, {
        type: 'bar',
        plugins: isHoriz ? [nameLabelPlugin] : [],
        data: {
          labels: dispTickers,
          datasets: [{
            data: dispValues,
            backgroundColor: dispColors,
            borderColor: dispBorders,
            borderWidth: 1,
            borderRadius: 4,
            xAxisID: 'x',
          }]
        },
        options: {
          indexAxis: isHoriz ? 'y' : 'x',
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: isHoriz ? { right: 10, left: 10 } : {} },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#16161a',
              borderColor: '#2a2a33',
              borderWidth: 1,
              titleColor: '#f0f0f0',
              bodyColor: '#f0f0f0',
              callbacks: {
                label: ctx => {
                  const v = ctx.raw;
                  const s = dispStocks[ctx.dataIndex];
                  const chg = getDayChange(s);
                  return ` ${fmt(v, 2)}  (${fmtPct(chg.pct)})`;
                }
              }
            }
          },
          scales: {
            x: {
              position: 'bottom',
              grid: { color: isHoriz ? '#1e1e24' : 'transparent' },
              ticks: isHoriz ? axisTickConfig : {
                font: { family: 'DM Mono', size: 15 },
                color: '#666672',
              }
            },
            ...(isHoriz ? {
              xTop: {
                type: 'linear',
                position: 'top',
                min: Math.min(...dispValues) * 1.15,
                max: Math.max(...dispValues) * 1.15,
                grid: { drawOnChartArea: false },
                ticks: axisTickConfig,
              }
            } : {}),
            y: {
              grid: { color: isHoriz ? 'transparent' : '#1e1e2e' },
              ticks: {
                font: { family: 'DM Mono', size: 15 },
                color: '#c8c8e0',
                callback: isHoriz
                  ? undefined
                  : v => (v >= 0 ? '$' : '-$') + Math.abs(v).toLocaleString()
              }
            }
          }
        }
      });
    }

    // â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadData() {
      document.getElementById('app').innerHTML = '<div class="empty-state loading"><p>Loading portfolioâ€¦</p></div>';
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
        const res  = await fetch(url);
        const json = await res.json();
        if (json.values && json.values.length > 1) {
          const headers = json.values[0];
          portfolioData = json.values.slice(1).map(row => {
            const obj = {};
            headers.forEach((h, i) => { obj[h] = row[i] || ''; });
            // Capture 52w High (col M = index 12) and 52w Low (col N = index 13) by position
            obj['_52wHigh'] = row[12] || '';
            obj['_52wLow']  = row[13] || '';
            return obj;
          });
          localStorage.setItem('sr_cache', JSON.stringify(portfolioData));
          render();
        } else {
          showError('No data found in sheet.');
        }
      } catch (e) {
        const cached = localStorage.getItem('sr_cache');
        if (cached) {
          portfolioData = JSON.parse(cached);
          render();
          document.getElementById('app').insertAdjacentHTML('beforeend',
            '<div class="timestamp" style="color:#f97316;">âš  Using cached data â€” could not refresh</div>');
        } else {
          showError('Error: ' + e.message);
        }
      }
    }

    function showError(msg) {
      document.getElementById('app').innerHTML = `<div class="empty-state"><p style="color:var(--red)">${msg}</p></div>`;
    }

    // â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openModal() {
      document.getElementById('sheetsUrl').value = SHEET_ID ? 'https://docs.google.com/spreadsheets/d/' + SHEET_ID : '';
      document.getElementById('apiKey').value    = API_KEY;
      document.getElementById('sheetName').value = SHEET_NAME;
      document.getElementById('modal').classList.add('open');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('open');
    }

    document.getElementById('setupBtn').onclick      = openModal;
    document.getElementById('emptySetupBtn').onclick = openModal;
    document.getElementById('cancelBtn').onclick     = closeModal;

    document.getElementById('saveBtn').onclick = () => {
      const urlInput = document.getElementById('sheetsUrl').value;
      const match    = urlInput.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!match) { alert('Invalid Sheets URL'); return; }
      SHEET_ID   = match[1];
      API_KEY    = document.getElementById('apiKey').value.trim();
      SHEET_NAME = document.getElementById('sheetName').value.trim() || 'Sheet1';
      localStorage.setItem('sr_sheetId',   SHEET_ID);
      localStorage.setItem('sr_apiKey',    API_KEY);
      localStorage.setItem('sr_sheetName', SHEET_NAME);
      closeModal();
      loadData();
    };

    // Close modal on backdrop click
    document.getElementById('modal').addEventListener('click', e => {
      if (e.target === document.getElementById('modal')) closeModal();
    });

    // â”€â”€ Resize: re-render on orientation change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (portfolioData.length) render();
      }, 250);
    });

    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (SHEET_ID && API_KEY) {
      loadData();
    }
  </script>
</body>
</html>
